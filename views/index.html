<!DOCTYPE html>
<html>
<head>
  <title>Opus</title>
  <style>

  .links line {
    stroke: #999;
    stroke-opacity: 0.6;
  }

  .nodes circle {
    stroke: #fff;
    stroke-width: 1.5px;
  }

  </style>
</head>
<body>
  <button id="getKanye">Get Kanye</button>
  <button id="getJay">Get JAY Z</button>
  <button id="getKanyeFriends">Get Kanye's Friends</button>
  <!--<button id="fetchKanyeSearch">Find Kanyes with Search</button> -->
  <svg width="1280" height="900"></svg>

 </body>

<footer>
  <script
    src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous">
  </script>

  <script type="text/javascript">

    // function start () {
    //   getKanye();
    //   getKanyeFriends();
    // }
    // function fetchKanyeSearch() {
    //   let myUrl = 'https://api.spotify.com/v1/search?query=kanye&type=artist&offset=0&limit=20';
    //   utilReceiveSearch(myUrl);
    // }

    function getKanye() {
      let id = '5K4W6rqBFWDnAN6FQUkS6x';
      utilReceiveArtist(id);
    }

    function getJay() {
      let id = '3nFkdlSjzX9mRTtwJOzDYB';
      utilReceiveArtist(id);
    }

    function getKanyeFriends() {
      let id = '5K4W6rqBFWDnAN6FQUkS6x';
      utilReceiveRelatedArtists(id);
    }

    // function PingSpotifyAPIAJAX(url) {
    //   $.ajax('/cors', { data: { url } }).then(
    //     response => {console.log(response)},
    //     (err) => console.error(err)
    //   )
    // }

    // $('#fetchKanyeSearch').click(fetchKanyeSearch)
    $('#getKanye').click(getKanye)
    $('#getJay').click(getJay)
    $('#getKanyeFriends').click(getKanyeFriends)
  </script>

  <script src="https://d3js.org/d3.v4.min.js"></script>


  <script type="text/javascript">
    // function searchNode(id){
    //   for (var i=0; i < ALL_NODES.length; i++) {
    //     if (ALL_NODES[i].id === id) {
    //         return ALL_NODES[i];
    //     }
    //   }
    // }

    let NODES_OBJ = {};
    let LINKS_OBJ = {};
    let CHOSEN_ARR = [];
    let nodes = [];
    let links = [];


    var svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height"),
      color = d3.scaleOrdinal(d3.schemeCategory20);


    svg.append("rect")
        // .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
        .attr("width", width)
        .attr("height", height)
        .style("fill", "#ffffff")
        .style("pointer-events", "all")
        .call(d3.zoom()
            .on("zoom", zoomed));

    function zoomed() {
      g.attr("transform", d3.event.transform);
    }

    var simulation = d3.forceSimulation()
      .force("collision", d3.forceCollide(50))
      .force("charge", d3.forceManyBody().strength(-30000).distanceMin(400))
      .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(140).strength(1).iterations(4))
      .force("center", d3.forceCenter(0, 0))
      .alphaDecay(0.003)
      .alpha(0.3)

      // .alpha(1.4)
      .on("tick", ticked);

      // .alpha(10)
      // .force("collide", d3.forceCollide(25).iterations(4))


    function dragstarted(d) {
      if (!d3.event.active) simulation.alphaTarget(0.2).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragended(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }


    var g = svg.append("g"),
      link = g.append("g").attr("stroke", "#000000").attr("stroke-width", 1).selectAll(".link"),
      node = g.append("g").selectAll(".node");
      text = g.append("g").selectAll(".text")
      image = g.append("g").selectAll(".image");
      // clipPath = g.append("g").selectAll(".clipPath");



    function PingSpotifyAPIAJAX(url) {
      return $.ajax('/cors', { data: { url } });
    }

    function utilReceiveArtist(id) {
      let url = `https://api.spotify.com/v1/artists/${id}`
      PingSpotifyAPIAJAX(url).then((response) => addParentNode(response)).then(() => utilReceiveRelatedArtists(id));
    }

    function addParentNode(response) {
      if (!NODES_OBJ[`${response.id}`]) {
        response['chosen'] = true;
        NODES_OBJ[`${response.id}`] = response;
      }
      CHOSEN_ARR.forEach((chosen) => {
        let linkKey = `${response.id}-${chosen.id}`;
        LINKS_OBJ[`${linkKey}`] = { "source": `${response.id}`, "target": `${chosen.id}`, "value": 6, };
      });
      CHOSEN_ARR.push(response);

      update();
    }

    function utilReceiveRelatedArtists(id) {
      let url = `https://api.spotify.com/v1/artists/${id}/related-artists`
      PingSpotifyAPIAJAX(url).then((response) => addRelativeNodes(response, id));
    }

    function addRelativeNodes(response, parentId) {
      artists = [response.artists[0]].concat(response.artists.slice(1, 11));
      // console.log(artists);
      artists.forEach((artist) => {
        if (!NODES_OBJ[`${artist.id}`]) {
          NODES_OBJ[`${artist.id}`] = artist;
        }
        let linkKey = `${artist.id}-${parentId}`;
        LINKS_OBJ[`${linkKey}`] = { "source": `${artist.id}`, "target": `${parentId}`, "value": 6, };
      });

      update();
    }

    clipPathId = 0

    function update() {
      let nodesArray = Object.values(NODES_OBJ);
      let linksArray = Object.values(LINKS_OBJ);

      node = node.data(nodesArray, function(d) { return d.id; } );
      node.exit().remove();
      node = node.enter()
        .append("circle")
        .attr('class', 'node')
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
        .attr("r", 34)
        .attr('fill', '#000')
        .on('click', (d) => utilReceiveRelatedArtists(`${d.id}`))
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended))
        .merge(node);

      node.filter(function(d, i) { return d.chosen } )
        // .attr('fill', function(d) {return color(2)})
        // .attr('fx', function(d, i) { return i * 50 })
        // .attr('fy', function(d, i) { return i * 50 });

      image = image.data(nodesArray, function(d) { return d.id; } );
      image.exit().remove();
      image = image.enter()
        .append('g')
        .attr('class', 'image')
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
        .on('click', (d) => utilReceiveRelatedArtists(`${d.id}`))
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended))
        .merge(image);

      image.append("clipPath")
        .attr('id', function(d) {return (`clipCircle${d.id}`)})
        .attr('class', 'clipPath')
        .append('circle')
        .attr('fill', '#222326')
        .attr("stroke", "#fff")
        .attr("stroke-width", 50)
        .attr('r', 32);

      image.append('image')
        .attr('xlink:href', function(d) { return d.images[0].url })
        .attr('width',
          function(d) {
            let artistImage = d.images[1];
            if (artistImage.width > artistImage.height) {
              return 64 * (artistImage.width / artistImage.height);
            }

            return 64;
          }
        )
        .attr('height',
          function(d) {
            let artistImage2 = d.images[0];
            if (artistImage2.height > artistImage2.width) {
              return 64 * (artistImage2.height / artistImage2.width);
            } else {
              return 64;

            }
          }
        )
        .attr('y', '-32px')
        .attr("clip-path", function(d) {return (`url(#clipCircle${d.id})`)})
        .attr('x', '-32px');

      link = link.data(linksArray, function(d) { return d.source.id + "-" + d.target.id; });
      link.exit().remove();
      link = link.enter()
        .append("line")
        .attr('class', 'link')
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
        .attr("fill", function(d) { return color(2); })
        .merge(link);


      text = text.data(nodesArray, function(d) { return d.id; } );
      text.exit().remove();
      text = text.enter()
        .append("text")
        .attr('class', 'text')
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
        .attr("dx", 38)
        .attr("dy", 3)
        .style("fill", "#000")
        .style("font-family", "Helvetica")
        .style("font-size", 16)
        .style('text-shadow', '0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff')
        .text(function(d) { return d.name })
        .merge(text);


      // console.log(node);
      // console.log(link);
      // console.log(nodesArray);
      // console.log(linksArray);
      // console.log(NODES_OBJ);
      // console.log(LINKS_OBJ);


      simulation.nodes(nodesArray);
      simulation.force("link").links(linksArray);
      simulation.restart();
    }

    function ticked() {
      node.attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; });

      text.attr("x", function(d) { return d.x; })
          .attr("y", function(d) { return d.y; });

      image.attr('transform', function(d) {
        let thisY = (d.y + height / 2);
        let thisX = (d.x + width / 2);
        return `translate(${thisX}, ${thisY})`
      });

      link.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });
    }


    // THIS IS BEFORE THE NEW ROLL W10D5 8:23PM


    // function receiveArtist(response) {
    //   response.x = width / 2;
    //   response.y = width / 2;
    //   ALL_NODES.push(response);
    //   let artistResponse = [response]
    //   let id = response.id;
    //
    //   var gnodes = svg.selectAll('g.chosen')
    //     .data(ALL_NODES, function (d) { return d.id; }) // to join the data, for transitions
    //     .enter()
    //     .append('g')
    //     .classed('gnode', true)
    //     .classed('chosen', true)
    //     .classed(`${id}`, true)
    //
    //   var node = gnodes.append("circle")
    //       .attr("r", 7)
    //       .attr("fill", function(d) { return color(1); } )
    //       .call(d3.drag()
    //           .on("start", dragstarted)
    //           .on("drag", dragged)
    //           .on("end", dragended));
    //
    //
    //     var label = gnodes.append("text")
    //       .text(function(d, i) { return d.name; })
    //       .attr('class', 'mytext')
    //       .attr("dy", ".35em")
    //       .attr("text-anchor", function(d) {
    //         return "start";
    //       })
    //       .style("fill", "#555")
    //       .style("font-family", "Arial")
    //       .style("font-size", 12)
    //
    //     simulation
    //         .nodes(ALL_NODES)
    //         .on("tick", ticked);
    //
    //
    //       function ticked() {
    //         node
    //             .attr("cx", function(d) { return d.x; })
    //             .attr("cy", function(d) { return d.y; });
    //         label
    //             .attr("x", function(d) { //<-- NEED TO POSITION THESE TOO
    //               return d.x;
    //             })
    //             .attr("y", function(d) {
    //               return d.y;
    //             });
    //         }
    // }
    //
    //
    //
    //
    //
    //
    //
    // function utilReceiveRelatedArtists(url) {
    //   PingSpotifyAPIAJAX(url).then((response) => receiveRelatedArtists(response, url));
    // }
    //
    // function receiveRelatedArtists(response, url) {
    //   console.log(response.artists);
    //   response.artists.forEach((artist) => {
    //     artist.x = width / 2;
    //     artist.y = width / 2;
    //     ALL_NODES.push(artist);
    //   });
    //
    //   let newUrl = url.slice(35, 57)
    //
    //   var relatedLinks = $.map(response.artists, function(d) {
    //     return {
    //       "source": d.id, "target": newUrl, "value": 6, "origin": d
    //     };
    //   });
    //
    //   relatedLinks.forEach((link) => {ALL_LINKS.push(link)})
    //
    //   d3.select("svg").selectAll("*").remove();
    //
    //   var link = svg.append("g")
    //       .attr("class", "links")
    //     .selectAll("line")
    //     .data(ALL_LINKS)
    //     .enter().append("line")
    //       .attr("stroke-width", function(d) { return Math.sqrt(d.value); });
    //
    //   var gnodes = svg.selectAll('g.gnode')
    //     .data(ALL_NODES, function(d){ return d.id;})
    //     .enter()
    //     .append('g')
    //     .classed('gnode', true)
    //
    //   var node = gnodes.append("circle")
    //       .attr("r", 15)
    //       .attr("fill", function(d) { return color(2); })
    //       .attr("x", function(d) { return width/2; })
    //       .attr("y", function(d) { return height/2; })
    //       .on('click', (d) => utilReceiveRelatedArtists(`https://api.spotify.com/v1/artists/${d.id}/related-artists`))
    //       .call(d3.drag()
    //           .on("start", dragstarted)
    //           .on("drag", dragged)
    //           .on("end", dragended));
    //
    //
    //     var label = gnodes.append("text")
    //       .text(function(d, i) { return d.name; })
    //       .attr('class', 'mytext')
    //       .attr("dy", "-2em")
    //       .attr("dx", "-1em")
    //       .attr("text-anchor", function(d) {
    //         return "start";
    //       })
    //       .style("fill", "#555")
    //       .style("font-family", "Arial")
    //       .style("font-size", 12)
    //
    //       simulation
    //           .nodes(ALL_NODES)
    //           .on("tick", ticked);
    //
    //       simulation.force("link")
    //           .links(ALL_LINKS);
    //
    //       function ticked() {
    //         link
    //             .attr("x1", function(d) { return d.source.x; })
    //             .attr("y1", function(d) { return d.source.y; })
    //             .attr("x2", function(d) { return d.target.x; })
    //             .attr("y2", function(d) { return d.target.y; });
    //         node
    //             .attr("cx", function(d) { return d.x; })
    //             .attr("cy", function(d) { return d.y; });
    //         label
    //             .attr("x", function(d) { //<-- NEED TO POSITION THESE TOO
    //               return d.x;
    //             })
    //             .attr("y", function(d) {
    //               return d.y;
    //             });
    //         }
    // }
    //
    // function utilReceiveSearch(url) {
    //   PingSpotifyAPIAJAX(url).then((response) => receiveSearch(response));
    // }
    //
    // function receiveSearch(response) {
    //   console.log(response);
    //
    //   var gnodes = svg.selectAll('g.gnode')
    //     .data(response.artists.items, function (d) { return d.id; }) // to join the data, for transitions
    //     .enter()
    //     .append('g')
    //     .classed('gnode', true)
    //
    //   var node = gnodes.append("circle")
    //       .attr("r", 7)
    //       .attr("fill", function(d) { return color(3); } )
    //       .attr("cx", function() { return Math.random() * 720; })
    //       .attr("cy", function() { return Math.random() * 720; })
    //       // .call(d3.drag()
    //       //     .on("start", dragstarted)
    //       //     .on("drag", dragged)
    //       //     .on("end", dragended));
    //
    //
    //     var label = gnodes.append("text")
    //       .text(function(d, i) { return d.name; })
    //       .attr('class', 'mytext')
    //       //  .attr("dy", ".35em")
    //       // .attr("text-anchor", function(d) {
    //       //   return "start";
    //       // })
    //       .style("fill", "#555")
    //       .style("font-family", "Arial")
    //       .style("font-size", 12)
    //       .attr("x", function() { return Math.random() * 720; })
    //       .attr("y", function() { return Math.random() * 720; })
    // }

// THIS IS AFTER THE NEW ROLL W10D5 8:23PM

    //       console.log(response)
    //       console.log(url)
    //       let artistResponse;
    //       if (response.artists && response.artists.items) {
    //         responseData = response.artists.items;
    //       } else if (response.artists) {
    //         responseData = response.artists;
    //       } else {
    //         responseData = [response];
    //       }
    //
    //       // var link = svg.append("g")
    //       //     .attr("class", "links")
    //       //     .selectAll("line")
    //       //     .data(graph.links)
    //       //     .enter().append("line")
    //       //     .attr("stroke-width", function(d) { return Math.sqrt(d.value); });
    //
    //
    //       var gnodes = svg.selectAll('g.gnode')
    //         .data(responseData, function (d) { return d.id; }) // to join the data, for transitions
    //         .enter()
    //         .append('g')
    //         .classed('gnode', true)
    //
    //       var node = gnodes.append("circle")
    //           .attr("r", 7)
    //           .attr("fill", 'black' )
    //           .attr("cx", function() { return Math.random() * 720; })
    //           .attr("cy", function() { return Math.random() * 720; })
    //           // .call(d3.drag()
    //           //     .on("start", dragstarted)
    //           //     .on("drag", dragged)
    //           //     .on("end", dragended));
    //
    //
    //         var label = gnodes.append("text")
    //             .text(function(d, i) { return d.name; })
    //             .attr('class', 'mytext')
    //             //  .attr("dy", ".35em")
    //             .attr("text-anchor", function(d) {
    //               return "start";
    //             })
    //             .style("fill", "#555")
    //             .style("font-family", "Arial")
    //             .style("font-size", 12)
    //             .attr("x", function() { return Math.random() * 720; })
    //             .attr("y", function() { return Math.random() * 720; })
    //
    //     },
    //     (err) => console.error(err)
    //   )
    // }
    //

    // start();
  </script>

</footer>
</html>
